<?php
namespace Modules\Admin\Http\Controllers;

use Illuminate\Support\Facades\Config;
use Illuminate\Support\Facades\Redirect;
use App\Http\Requests;
use Illuminate\Http\Request;
use Modules\Admin\Http\Requests\UserRequest;
use Modules\Admin\Http\Requests\CorporateProfileRequest;
use Modules\Admin\Models\User;
use Modules\Admin\Models\CorporateProfile;
use Modules\Admin\Models\Criteria;
use Input;
use Validator;
use Auth;
use Paginate;
use Grids;
use HTML;
use Form;
use View;
use URL;
use Lang;
use App\Http\Controllers\Controller;
use App\Helpers\Helper as Helper;
use Modules\Admin\Models\Interview;
use Modules\Admin\Models\InterviewRating;
use Carbon;
use DateTime;
/**
 * Class AdminController
 */
class InterviewController extends Controller {
    /**
     * @var  Repository
     */
   
    /**
     * Displays all admin.
     *
     * @return \Illuminate\View\View
     */
    public function __construct() {
        $this->middleware('admin');
        View::share('viewPage', 'Corporate Profile');
        $this->record_per_page = Config::get('app.record_per_page');
    }
    protected $criteria;
    /*
     * Dashboard
     * */
    public function index($id) 
    {
        
        $condidate_id   =  $id; 
        $condidate_name =  Helper::getCondidateNameByID($condidate_id);
        if($condidate_name==null)
        {
            return  json_encode([  
                            "status"=>0,
                            "code"=> 404,
                            "message"=>"Record not found", 
                            'data' => ""
                        ] 
                    );  
        }
         

        $interview_data =  InterviewRating::where('condidateID',$condidate_id)->get();
        $interview_details = [];
        $c_details =  Interview::find($condidate_id);
        $interviewerComment = [];
        $date = \Carbon\Carbon::parse($c_details->created_at)->format('d/m/Y');
        if($interview_data->count()>0)
        {   $interview_criteriaID =[];
            foreach ($interview_data as $key => $result) {
                $rating_value    = str_getcsv($result->rating_value);
                $interviewerName = Helper::getUserDetails($result->interviewerID);
                if( !empty($result->comment))
                {
                  $interviewerComment[]  = $result->comment;  
                }    
                
                $interview_details[]   =  Helper::getCriteriaById(str_getcsv($result->interview_criteriaID),$rating_value,$interviewerName,$result->comment); 
                 
            }
        }else{ 
             $condidates =   array(
                               "date"=>$date,
                              "details"=>$interview_details,
                              "comment"=>$interviewerComment,
                                );  
        } 
        $condidates =  array(
                        "date"=>$date,
                        "details"=>$interview_details,
                        "comment"=>$interviewerComment,
                        );

                  
        $page_title = "Rating Detail";
        $page_action = "Condidate Detail";
        $rating_detail = $condidates['details'];
        $comment =  $interviewerComment;
        
        return view('packages::corporateProfile.condidate_details', compact('comment','c_details','rating_detail', 'page_title', 'page_action'));
    }

    public function getRecentCondidateRecord(Request $request,Interview $interview)
    {   
       // $user_id = $request->get('userID'); 
        $user_id =  $request->get('userID');
         
        
        if(empty($user_id))
        {
            return  response()->json([ 
                "status"=>0,
                "code"=> 404,
                "message"=>"UserID required!",
                "data"  => ""
               ]
            );
        } 

        $corp_profile       = CorporateProfile::where('userID',$user_id)->get();
        $corp_profile_name  = $corp_profile->lists('company_url','userID');
        if($corp_profile->count()==0)
        {
            return  response()->json([ 
                "status"=>0,
                "code"=> 404,
                "message"=>"Unauthorised access!",
                "data"  => ""
               ]
            );
        } 

        $user_from_same_company = CorporateProfile::where('company_url',$corp_profile_name[$user_id])->get();
        $same_company_id    =   $user_from_same_company->lists('userID');
        $get_interviewer_list = User::whereIn('userID', $user_from_same_company->lists('userID'))
                                     ->where('status',1)->get();
         
        $interview_details = [];

         foreach ($user_from_same_company as $key => $user_record) { 
            $interviewD = Interview::where(function($query) use($user_record){
                $query->whereRaw('FIND_IN_SET('.$user_record->userID.',interviewerID)');
                }
            )
            ->get(); 
            $interview_condidate_data = $interviewD->lists('interviewerID','id'); 
            foreach ($interview_condidate_data as $key => $icd) {   
                $interviewData[$key] = $icd;
            } 
        }    
         ksort($interviewData);
        $interview_details_p=[]; 
        $interview_details_c=[];
        foreach ($interviewData as $cid => $cvalue) {
             
            $interview = Interview::where('id',$cid)->get(); 
            $condidate_detail  =  Helper::getCondidateNameByID($cid);
                 
            foreach ($interview as $key => $condidate) {
                
                $condidate_id   = $condidate->id;
                $int_ids = str_getcsv($condidate->interviewerID);
                $interview_data =  InterviewRating::where('condidateID',$condidate_id )
                                    ->whereIn('interviewerID',$int_ids)
                                    ->get();
                
                //$interview_details_c =[];
                $rate_int_id='';         
                if($interview_data->count()>0)
                {    
                    $interview_criteriaID =[];
                    foreach ($interview_data as $key => $result) {
                        $rate_int_id = $result->interviewerID;
                        $rating_value    = str_getcsv($result->rating_value);
                        $interviewerName = Helper::getUserDetails($result->interviewerID);
                        $interview_details['evaluated'][]   =  Helper::getAllCondidateDetails(str_getcsv($result->interview_criteriaID),$rating_value,$interviewerName,$result->comment); 
                    }
                    
                 }   
                    
                $pending_int_ids = str_getcsv($condidate->interviewerID);
                foreach ($same_company_id as $key => $arrData) {
                       $arr_usedID[] = $arrData;
                }  
                foreach ($pending_int_ids as $key => $pid) {
                    
                    if($pid!=$rate_int_id && (in_array($pid, $arr_usedID)))
                    {
                        if($pid!=null){
                            $interviewerName2 = Helper::getUserDetails($pid);
                            $rating_value    = [];
                            $criteriaIDs = str_getcsv($condidate->criteriaID);
                            $comments = $condidate->comment;
                            $interview_details['pending'][]   =  Helper::getAllCondidateDetails($criteriaIDs,$rating_value,$interviewerName2,$comments); 
                        }
                    } 
                 }
                
            $arr_data[] = ['condidateDetail'=>$condidate_detail, 'result'=>$interview_details];
            }
            $interview_details=[];  
            $rate_int_id =null;    
        }     
       $mine_interview = $this->mineRecentCondidateInterview($user_id,$same_company_id);
        return  response()->json([ 
                    "status"=>1,
                    "code"=> 200,
                    "message"=>"Record found successfully.",
                    "data"  =>  ['allRecentData'=>$arr_data,'mineRecent'=>$mine_interview]
                   ]
                );  
    } 

    /*
     * Edit Group method
     * @param 
     * object : $user
     * */

    public function edit(corporateProfile $corporateProfile) {
      }

    public function update(CriteriaRequest $request, Criteria $criteria) {
    }
    /*
     *Delete User
     * @param ID
     * 
     */
    public function destroy(CorporateProfile $corporateProfile) {

        
    }
    
    /* @method : Get Directory
    * @param : Interviewer ID
    * Response : json
    * Return :  
    */
    public function show(Request $request ,corporateProfile $corporateProfile)
    { 
        $page_title ="Condidate Directory";
        $page_action = "View";

        $corporate_profile  = CorporateProfile::find($corporateProfile->id);
        $user_id = $corporate_profile->userID;

        $is_user_exist = Helper::isUserExist($user_id);
       
        if(!$is_user_exist){
            return  [ 
                    "status"    =>  0,
                    "message"   =>  "Record not found",
                    'data'      =>  ""
                   ]
                 ;
        }
        $corp_profile       = CorporateProfile::where('userID',$user_id)->get();
        $corp_profile_name  = $corp_profile->lists('company_url','userID');


        $user_from_same_company = CorporateProfile::where('company_url',$corp_profile_name[$user_id])->get();
         
        $get_interviewer_list = User::whereIn('userID', $user_from_same_company->lists('userID'))
                                     ->where('status',1)->get();
        $condidate=[];
        foreach ($get_interviewer_list as $key => $value) {
          $search =  $request->get('search');
          $uid = $value->userID;
          $condidate = Interview::where(function($query) use($search, $uid) {
              $query->whereRaw('FIND_IN_SET('.$uid.',interviewerID)');
              if($search){ 
                  $query->Where('condidate_name', 'LIKE', "%$search%");
              }
          })->Paginate($this->record_per_page); 
                    
          if($condidate->count())
          {   
            $user_id = $value->userID;
            break;
          } 
        }
        $c_name = $corporate_profile->company_url;  
        if($condidate==[])
        {   $condidates = $condidate;
            
            return view('packages::corporateProfile.condidate', compact('c_name','condidates', 'page_title', 'page_action'));  
        }    

        $my_data = [];
        foreach ($condidate as $key => $condidate_record) {
            
            $interviewer_data = Helper::getInterviewerFromInterview($condidate_record->interviewerID);
            
            $my_data[] =   [
                            'condidateName' =>  $condidate_record->condidate_name,
                            'condidateID' =>  $condidate_record->id,
                            'shortDescription' => $condidate_record->short_description,
                            'comment'   =>    $condidate_record->comment,
                            'rating'    => Helper::getRatingByCondidateID($condidate_record->id),
                            'interviewer' => [$interviewer_data]
                        ];

        }
        $temp_data = [];
        $condidate =''; 
        $data= [];

        foreach ($user_from_same_company as $key => $user_record) {
            $condidate =  Interview::whereRaw('FIND_IN_SET('.$user_record->userID.',interviewerID)')
                                    ->Where('condidate_name', 'LIKE', "%$search%")
                                    ->Paginate($this->record_per_page);
            if($condidate->count()==0)
            {   
              continue;
            } 
            $pagination =  $condidate;
            foreach ($condidate as $key => $condidate_record) {
            
            $interviewer_all_data = Helper::getInterviewerFromInterview($condidate_record->interviewerID);

            
             $temp_data[] =   [
                            'condidateName' =>  $condidate_record->condidate_name,
                            'condidateID' =>  $condidate_record->id,
                            'shortDescription' => $condidate_record->short_description,
                            'comment'   =>    $condidate_record->comment,
                            'rating'    => Helper::getRatingByCondidateID($condidate_record->id),
                            'interviewer' => [$interviewer_all_data]
                        ]; 
            }
        }

        $all_data = array();
        foreach ($temp_data as $key => $value) {
                 $all_data[$value['condidateID']] = $value;

            }
        foreach ($all_data as $key => $value) {
               
               $data[] =   $value;   
        }        
        $condidates = $data ;
        
        return view('packages::corporateProfile.condidate', compact('c_name'  ,'pagination','condidates', 'page_title', 'page_action'));
    }
    public function corporateUser($name,Request $request)
    {
        $page_title ="Corporate User Profile";
        $page_action = $name;
        $cp =  CorporateProfile::with('user')->where('company_url',$name)->get();
        
        $user_ids = [];
        foreach ($cp as $key => $cp_user) {
          $user_ids[] = $cp_user->userID;
         } 
        $search =  $request->get('search');
        
        $users = User::with('position','corporateProfile')->whereIn('userID',$user_ids )->paginate(5);
        
         
        $search = Input::get('search');
        if (isset($search) && !empty($search)) {

            $search = isset($search) ? Input::get('search') : '';
               
            $users = User::with('position','corporateProfile')->where(function($query) use($search,$user_ids) {
                            if (!empty($search)) {
                            $query->Where('first_name', 'LIKE', "%$search%")
                                    ->OrWhere('last_name', 'LIKE', "%$search%")
                                    ->OrWhere('email', 'LIKE', "%$search%");
                                     
                            }
                             
                       
                    })->whereIn('userID',$user_ids )->paginate(10);
        }  
         
        return view('packages::corporateProfile.corporate_user', compact('request','users', 'page_title', 'page_action'));
    
    }
    

}
